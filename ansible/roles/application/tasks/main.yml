---
- name: Check if using Git or local files
  set_fact:
    use_git: "{{ (backend_repo is defined and backend_repo != '') and (frontend_repo is defined and frontend_repo != '') }}"

- name: Debug use_git value
  debug:
    msg: "use_git={{ use_git }}, backend_repo={{ backend_repo | default('NOT DEFINED') }}, frontend_repo={{ frontend_repo | default('NOT DEFINED') }}"

- name: Deploy from Git repositories
  include_tasks: deploy_from_git.yml
  when: use_git | bool

- name: Deploy from local files
  include_tasks: deploy_from_local.yml
  when: not (use_git | bool)

- name: Create backend environment file
  template:
    src: backend.env.j2
    dest: "{{ app_dir }}/backend/.env"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'

- name: Create frontend environment file
  template:
    src: frontend.env.j2
    dest: "{{ app_dir }}/frontend/.env.production"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'

- name: Install Node.js {{ nodejs_version }} (para rodar app fora do Docker)
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }}.x | bash - && \
    apt-get install -y nodejs
  args:
    executable: /bin/bash
  when: not use_docker_for_app | bool

- name: Install backend dependencies (npm ci)
  community.general.npm:
    path: "{{ app_dir }}/backend"
    production: false
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool

- name: Build backend (NestJS)
  command: npm run build
  args:
    chdir: "{{ app_dir }}/backend"
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool

- name: Run database migrations (host)
  command: npm run migration:run
  args:
    chdir: "{{ app_dir }}/backend"
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool
  ignore_errors: yes

- name: Run database seeds (host)
  command: npm run seed
  args:
    chdir: "{{ app_dir }}/backend"
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool
  ignore_errors: yes

- name: Install frontend dependencies (npm ci)
  community.general.npm:
    path: "{{ app_dir }}/frontend"
    production: false
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool

- name: Build frontend (Next.js)
  command: npm run build
  args:
    chdir: "{{ app_dir }}/frontend"
  environment:
    NODE_ENV: production
  when: not use_docker_for_app | bool

- name: Configure backend systemd service
  template:
    src: cs-skin-go-backend.service.j2
    dest: /etc/systemd/system/cs-skin-go-backend.service
    owner: root
    group: root
    mode: '0644'
  when: not use_docker_for_app | bool

- name: Configure frontend systemd service
  template:
    src: cs-skin-go-frontend.service.j2
    dest: /etc/systemd/system/cs-skin-go-frontend.service
    owner: root
    group: root
    mode: '0644'
  when: not use_docker_for_app | bool

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  when: not use_docker_for_app | bool

- name: Enable and restart backend service
  systemd:
    name: cs-skin-go-backend.service
    enabled: yes
    state: restarted
  when: not use_docker_for_app | bool

- name: Enable and restart frontend service
  systemd:
    name: cs-skin-go-frontend.service
    enabled: yes
    state: restarted
  when: not use_docker_for_app | bool

- name: Create docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'

- name: Stop MySQL container (se existir)
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    state: absent
  ignore_errors: yes

- name: Start only MySQL container
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    state: present
    pull: always
  become_user: "{{ app_user }}"

- name: Wait for MySQL to be ready
  wait_for:
    host: localhost
    port: 3306
    delay: 10
    timeout: 60

- name: Wait for backend to be ready
  wait_for:
    host: localhost
    port: "{{ backend_port }}"
    delay: 5
    timeout: 180

- name: Wait for frontend to be ready
  wait_for:
    host: localhost
    port: "{{ frontend_port }}"
    delay: 5
    timeout: 120

- name: Verify all containers are running
  community.docker.docker_container_info:
    name: "{{ item }}"
  register: container_info
  failed_when: not container_info.container.State.Running
  loop:
    - "{{ app_name }}-mysql"


